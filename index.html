<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thử Đồ Trực Tuyến</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.5s ease;
        }
        .card {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90vw;
            width: 550px;
            margin: 2rem;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.15), 0 15px 15px -5px rgba(0, 0, 0, 0.08);
        }
        input[type="file"] {
            border: 2px dashed #d1d5db;
            padding: 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #f9fafb;
        }
        input[type="file"]:hover {
            border-color: #6366f1;
            background-color: #f3f4f6;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type="file"] {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .custom-file-input {
            border: 2px dashed #d1d5db;
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: #f9fafb;
            text-align: center;
            color: #4b5563;
            transition: all 0.2s;
        }
        .custom-file-input:hover {
            border-color: #6366f1;
            background-color: #f3f4f6;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #6366f1;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: opacity 0.5s ease;
        }
        /* CSS for smooth fade-in */
        .fade-in {
            animation: fadeIn 0.8s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="card flex flex-col items-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Thử Đồ Trực Tuyến</h1>
        
        <p class="text-gray-500 mb-8 text-center text-sm">Sử dụng sức mạnh của AI để thử trang phục.</p>

        <!-- Container for inputs -->
        <div class="flex flex-col md:flex-row gap-6 w-full mb-6">
            <div class="flex-1">
                <label for="personImage" class="block text-sm font-medium text-gray-700 mb-2">Ảnh của bạn</label>
                <div class="file-input-wrapper">
                    <input type="file" id="personImage" accept="image/*">
                    <div class="custom-file-input">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        <span id="personFileName">Chọn ảnh của bạn</span>
                    </div>
                </div>
                <!-- Image preview for person -->
                <div id="personPreviewContainer" class="mt-4 hidden">
                    <img id="personPreview" class="image-preview" alt="Xem trước ảnh của bạn">
                </div>
            </div>
            <div class="flex-1">
                <label for="clothesImage" class="block text-sm font-medium text-gray-700 mb-2">Ảnh quần áo</label>
                <div class="file-input-wrapper">
                    <input type="file" id="clothesImage" accept="image/*">
                    <div class="custom-file-input">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        <span id="clothesFileName">Chọn ảnh quần áo</span>
                    </div>
                </div>
                <!-- Image preview for clothes -->
                <div id="clothesPreviewContainer" class="mt-4 hidden">
                    <img id="clothesPreview" class="image-preview" alt="Xem trước ảnh quần áo">
                </div>
            </div>
        </div>

        <button id="generateBtn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl hover:bg-indigo-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-offset-2">
            Thử đồ ngay!
        </button>

        <!-- Loading indicator -->
        <div id="loadingIndicator" class="hidden spinner mt-6"></div>

        <!-- Result section -->
        <div id="resultContainer" class="mt-8 w-full flex flex-col items-center hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Kết quả</h2>
            <img id="resultImage" class="image-preview" alt="Kết quả thử đồ">
            <a id="downloadBtn" download="thu-do-truc-tuyen.png" class="mt-4 inline-block bg-green-500 text-white font-semibold py-2 px-4 rounded-xl hover:bg-green-600 transition duration-300 transform hover:scale-105">
                Tải ảnh về
            </a>
        </div>

        <!-- Message box for errors or success -->
        <div id="messageBox" class="mt-4 p-4 text-sm rounded-lg text-center" style="display:none;"></div>
    </div>

    <script>
        // Get DOM elements
        const personInput = document.getElementById('personImage');
        const clothesInput = document.getElementById('clothesImage');
        const personFileNameSpan = document.getElementById('personFileName');
        const clothesFileNameSpan = document.getElementById('clothesFileName');
        const personPreview = document.getElementById('personPreview');
        const clothesPreview = document.getElementById('clothesPreview');
        const personPreviewContainer = document.getElementById('personPreviewContainer');
        const clothesPreviewContainer = document.getElementById('clothesPreviewContainer');
        const generateBtn = document.getElementById('generateBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultContainer = document.getElementById('resultContainer');
        const resultImage = document.getElementById('resultImage');
        const messageBox = document.getElementById('messageBox');
        const downloadBtn = document.getElementById('downloadBtn');

        // Function to display filename and image preview
        const displayImagePreview = (file, fileNameSpan, previewImg, previewContainer) => {
            if (file) {
                fileNameSpan.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                    previewImg.classList.add('fade-in'); // Add fade-in animation class
                };
                reader.readAsDataURL(file);
            } else {
                fileNameSpan.textContent = fileNameSpan.id.includes('person') ? "Chọn ảnh của bạn" : "Chọn ảnh quần áo";
                previewContainer.classList.add('hidden');
            }
        };

        // Event listeners for file inputs
        personInput.addEventListener('change', (event) => {
            displayImagePreview(event.target.files[0], personFileNameSpan, personPreview, personPreviewContainer);
        });

        clothesInput.addEventListener('change', (event) => {
            displayImagePreview(event.target.files[0], clothesFileNameSpan, clothesPreview, clothesPreviewContainer);
        });

        // Function to show a message in the message box
        function showMessage(text, type = 'error') {
            messageBox.style.display = 'block';
            messageBox.textContent = text;
            if (type === 'error') {
                messageBox.style.backgroundColor = '#fee2e2';
                messageBox.style.color = '#dc2626';
            } else if (type === 'success') {
                messageBox.style.backgroundColor = '#dcfce7';
                messageBox.style.color = '#15803d';
            }
        }

        // Function to hide the message box
        function hideMessage() {
            messageBox.style.display = 'none';
        }

        // Event listener for the generate button
        generateBtn.addEventListener('click', async () => {
            hideMessage();
            resultContainer.classList.add('hidden');

            const personFile = personInput.files[0];
            const clothesFile = clothesInput.files[0];

            if (!personFile || !clothesFile) {
                showMessage('Vui lòng tải lên cả hai ảnh: ảnh của bạn và ảnh quần áo.');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            generateBtn.disabled = true;

            try {
                // Function to read file as base64
                const readAsBase64 = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                };

                const personBase64 = await readAsBase64(personFile);
                const clothesBase64 = await readAsBase64(clothesFile);

                const prompt = "Please edit the first image. The person in the first image is wearing a shirt. I have a second image of a new shirt. Please make the person in the first image wear the shirt from the second image. The new image should look like the person is realistically wearing the new shirt. The original shirt in the first image should be replaced with the new shirt from the second image.";
                
                const payload = {
                    contents: [
                        {
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: personFile.type, data: personBase64 } },
                                { inlineData: { mimeType: clothesFile.type, data: clothesBase64 } }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseModalities: ["TEXT", "IMAGE"]
                    },
                };
                
                // API configuration and key
                const apiKey = "AIzaSyAMVhuvXBRBmPoxWFvn_KZtXIkqtO9OCWs";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent?key=${apiKey}`;

                // API call with exponential backoff
                const fetchWithRetry = async (url, options, retries = 5, delay = 1000) => {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            if (response.status === 429 && retries > 0) { // Too Many Requests
                                await new Promise(res => setTimeout(res, delay));
                                return fetchWithRetry(url, options, retries - 1, delay * 2);
                            }
                            throw new Error(`API Error: ${response.status}`);
                        }
                        return response;
                    } catch (error) {
                        if (retries > 0) {
                            await new Promise(res => setTimeout(res, delay));
                            return fetchWithRetry(url, options, retries - 1, delay * 2);
                        }
                        throw error;
                    }
                };

                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) {
                    throw new Error("Không thể tạo ảnh. Vui lòng thử lại với các ảnh khác.");
                }

                // Display result
                const imageUrl = `data:image/png;base64,${base64Data}`;
                resultImage.src = imageUrl;
                resultContainer.classList.remove('hidden');
                resultImage.classList.add('fade-in');
                showMessage('Ghép ảnh thành công!', 'success');
                downloadBtn.href = imageUrl; // Set the download link

            } catch (error) {
                console.error("Lỗi:", error);
                showMessage('Đã xảy ra lỗi trong quá trình xử lý. Vui lòng thử lại.');
            } finally {
                loadingIndicator.classList.add('hidden');
                generateBtn.disabled = false;
            }
        });
    </script>
</body>
</html>